vc-preamble: |-
  function upper_sum_rec(s: string): int
    // post-conditions-start
    ensures upper_sum_rec(s) >= 0
    // post-conditions-end
  {
    // impl-start
    if |s| == 0 then
      0
    else
      var remaining := upper_sum_rec(s[1..]);
      to_int(s[0]) + remaining
    // impl-end
  }
  function to_int(c: char): int
      ensures 'A' <= c <= 'Z' ==> to_int(c) == c as int
      ensures c < 'A' || c > 'Z' ==> to_int(c) == 0
  {
      if 'A' <= c <= 'Z' then c as int else 0
  }

vc-helpers: |-
  lemma upper_sum_invariant(s: string, i: int, acc: int)
      requires 0 <= i <= |s|
      requires acc == upper_sum_rec(s[..i])
      ensures acc + upper_sum_rec(s[i..]) == upper_sum_rec(s)
  {
      if i == 0 {
          assert s[..0] == "";
          assert s[0..] == s;
      } else if i == |s| {
          assert s[i..] == "";
          assert s[..i] == s;
      } else {
          assert s == s[..i] + s[i..];
          upper_sum_concat_lemma(s[..i], s[i..]);
      }
  }
  
  lemma upper_sum_concat_lemma(s1: string, s2: string)
      ensures upper_sum_rec(s1 + s2) == upper_sum_rec(s1) + upper_sum_rec(s2)
  {
      if |s1| == 0 {
          assert s1 + s2 == s2;
      } else {
          assert (s1 + s2)[0] == s1[0];
          assert (s1 + s2)[1..] == s1[1..] + s2;
          upper_sum_concat_lemma(s1[1..], s2);
      }
  }

vc-description: |-
  function_signature: def digitSum(string: str) -> Nat
  Write a function that takes a string as input and returns the sum of the upper characters only' ASCII codes.

vc-spec: |-
  method upper_sum(s: string) returns (res: int)
      // post-conditions-start
      ensures res == upper_sum_rec(s)
      // post-conditions-end

vc-code: |-
  {
      res := 0;
      var i := 0;
      
      while i < |s|
          invariant 0 <= i <= |s|
          invariant res == upper_sum_rec(s[..i])
      {
          res := res + to_int(s[i]);
          i := i + 1;
          
          assert s[..i] == s[..i-1] + [s[i-1]];
          upper_sum_concat_lemma(s[..i-1], [s[i-1]]);
      }
      
      assert s[..|s|] == s;
  }

vc-postamble: |-


