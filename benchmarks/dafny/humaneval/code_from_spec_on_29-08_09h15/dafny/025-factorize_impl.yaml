vc-preamble: |-
  function prod(s: seq<int>) : int {
    if |s| == 0 then 1 else prod(s[..|s| - 1]) * s[|s| - 1]
  }

vc-helpers: |-
  predicate isPrime(p: nat)
  {
    p > 1 && forall k :: 2 <= k < p ==> p % k != 0
  }
  
  lemma prodAppend(s: seq<int>, x: int)
    ensures prod(s + [x]) == prod(s) * x
  {
    if |s| == 0 {
      assert s + [x] == [x];
      assert prod([x]) == 1 * x == x;
      assert prod(s) * x == 1 * x == x;
    } else {
      assert s + [x] == s[..|s|] + [x];
      assert (s + [x])[..|s + [x]| - 1] == s;
      assert (s + [x])[|s + [x]| - 1] == x;
      assert prod(s + [x]) == prod(s) * x;
    }
  }
  
  lemma prodEmpty()
    ensures prod([]) == 1
  {
  }
  
  lemma prodSingle(x: int)
    ensures prod([x]) == x
  {
    assert prod([x]) == prod([]) * x == 1 * x == x;
  }

vc-description: |-
  function_signature: def factorize(n: int) -> List[int]
  Return list of prime factors of given integer in the order from smallest to largest. Each of the factors should be listed number of times corresponding to how many times it appeares in factorization. Input number should be equal to the product of all factors

vc-spec: |-
  method factorize(n: nat) returns (factors: seq<nat>)
    // pre-conditions-start
    requires n > 0
    // pre-conditions-end
    // post-conditions-start
    ensures prod(factors) == n
    // post-conditions-end

vc-code: |-
  {
    factors := [];
    var remaining := n;
    var divisor := 2;
    
    while remaining > 1
      invariant remaining >= 1
      invariant prod(factors) * remaining == n
      invariant divisor >= 2
      invariant remaining == 1 || divisor <= remaining
      decreases remaining, remaining - divisor
    {
      if remaining % divisor == 0 {
        factors := factors + [divisor];
        prodAppend(factors[..|factors|-1], divisor);
        remaining := remaining / divisor;
        divisor := 2;
      } else {
        divisor := divisor + 1;
      }
    }
    
    assert remaining == 1;
    assert prod(factors) * 1 == n;
    assert prod(factors) == n;
  }

vc-postamble: |-


