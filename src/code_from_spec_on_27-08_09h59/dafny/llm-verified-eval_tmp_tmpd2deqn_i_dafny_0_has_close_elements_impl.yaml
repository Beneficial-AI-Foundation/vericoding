vc-preamble: |-
  function abs(x: real): real
  {
    if x < 0.0 then -x else x
  }

vc-helpers: |-
  lemma abs_properties(x: real, y: real)
      ensures abs(x - y) == abs(y - x)
  {
  }
  
  lemma close_elements_found(numbers: seq<real>, threshold: real, i: int, j: int)
      requires 0 <= i < |numbers|
      requires 0 <= j < |numbers|
      requires i != j
      requires abs(numbers[i] - numbers[j]) < threshold
      ensures exists ii, jj ::
        0 <= ii < |numbers| &&
        0 <= jj < |numbers| &&
        ii != jj &&
        abs(numbers[ii] - numbers[jj]) < threshold
  {
  }

vc-spec: |-
  // <vc-spec>
  method has_close_elements(numbers: seq<real>, threshold: real) returns (result: bool)
      ensures result <==> exists i, j ::
        0 <= i < |numbers| &&
        0 <= j < |numbers| &&
        i != j &&
        abs(numbers[i] - numbers[j]) < threshold
      ensures result ==> |numbers| > 1
  // </vc-spec>

vc-code: |-
  {
      if |numbers| <= 1 {
          return false;
      }
      
      var i := 0;
      while i < |numbers|
          invariant 0 <= i <= |numbers|
          invariant forall ii, jj ::
              0 <= ii < i &&
              0 <= jj < |numbers| &&
              ii != jj ==>
              abs(numbers[ii] - numbers[jj]) >= threshold
      {
          var j := 0;
          while j < |numbers|
              invariant 0 <= j <= |numbers|
              invariant forall ii, jj ::
                  0 <= ii < i &&
                  0 <= jj < |numbers| &&
                  ii != jj ==>
                  abs(numbers[ii] - numbers[jj]) >= threshold
              invariant forall jj ::
                  0 <= jj < j &&
                  i != jj ==>
                  abs(numbers[i] - numbers[jj]) >= threshold
          {
              if i != j && abs(numbers[i] - numbers[j]) < threshold {
                  close_elements_found(numbers, threshold, i, j);
                  return true;
              }
              j := j + 1;
          }
          i := i + 1;
      }
      
      return false;
  }

vc-postamble: |-


