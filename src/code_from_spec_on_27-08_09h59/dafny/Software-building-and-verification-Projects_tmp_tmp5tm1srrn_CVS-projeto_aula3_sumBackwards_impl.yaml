vc-preamble: |-
  function fib(n : nat) : nat
  {
    if (n==0) then 1 else
    if (n==1) then 1 else fib(n-1)+fib(n-2)
  }
  
  
  // 2.
  datatype List<T> = Nil | Cons(head: T, tail: List<T>)
  
  function add(l : List<int>) : int {
    match l
    case Nil => 0
    case Cons(x,xs) => x + add(xs)
  }
  
  
  // 3.
  
  // 5.
  
  // 6
  function sum(n: nat) : nat
  {
    if (n == 0) then 0 else n + sum(n-1)
  }

vc-helpers: |-
  lemma SumBackwardsCorrect(i: nat, acc: nat, n: nat)
    requires i <= n
    ensures acc + sum(n) - sum(i) == acc + sum(n) - sum(i)
  {
  }
  
  lemma SumAdditive(a: nat, b: nat)
    requires a <= b
    ensures sum(b) == sum(a) + SumRange(a + 1, b)
    decreases b - a
  {
    if a == b {
      assert SumRange(a + 1, b) == SumRange(a + 1, a) == 0;
      assert sum(b) == sum(a) + 0;
    } else {
      SumAdditive(a + 1, b);
      assert sum(b) == sum(a + 1) + SumRange(a + 2, b);
      assert sum(a + 1) == sum(a) + (a + 1);
      assert SumRange(a + 1, b) == (a + 1) + SumRange(a + 2, b);
    }
  }
  
  function SumRange(start: nat, end: nat): nat
    requires start <= end + 1
    decreases end + 1 - start
  {
    if start > end then 0
    else start + SumRange(start + 1, end)
  }
  
  lemma SumRangeEquivalent(n: nat)
    ensures sum(n) == SumRange(1, n)
  {
    if n == 0 {
      assert sum(0) == 0;
      assert SumRange(1, 0) == 0;
    } else {
      SumRangeEquivalent(n - 1);
      assert sum(n - 1) == SumRange(1, n - 1);
      assert sum(n) == n + sum(n - 1);
      assert sum(n) == n + SumRange(1, n - 1);
      assert SumRange(1, n) == 1 + SumRange(2, n);
      SumAdditive(1, n);
      assert sum(n) == sum(1) + SumRange(2, n);
      assert sum(1) == 1;
      assert sum(n) == 1 + SumRange(2, n);
    }
  }

vc-spec: |-
  // <vc-spec>
  method sumBackwards(n: nat) returns (r: nat)
    ensures r == sum(n)
  // </vc-spec>

vc-code: |-
  {
    r := 0;
    var i := n;
    while i > 0
      invariant 0 <= i <= n
      invariant r + sum(i) == sum(n)
    {
      r := r + i;
      i := i - 1;
    }
  }

vc-postamble: |-


