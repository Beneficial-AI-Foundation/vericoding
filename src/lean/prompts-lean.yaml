generate_code: |
  The task is to generate implementations and proofs for "sorry" placeholders in a Lean file.
  
  INPUT: a Lean file containing {sorry_count} "sorry" keywords in place of desired implementations and proofs.
  
  OUTPUT: Return a JSON array with EXACTLY {sorry_count} replacements (one for each "sorry" in the file), in order from top to bottom:
  ```json
  ["first_implementation", "second_proof", "third_implementation"]
  ```
  STRATEGY: Do a high-level plan using sorries. Then focus on eliminating the sorries one by one. To eliminate a sorry, try a proof. Likely there will be an error. Replace every line after that error (until the end of the subgoal) with trace_state and then sorry. Then slowly push the subproof forward one correct line at a time, backtracking a line when the line is wrong. Also try grind on small sorries.

  To summarize, if you see no proof at all, make a high-level sketch proof that uses sorries and trace_state. If you see a high-level sketch proof that uses sorries, insert trace_state before the first sorry. If you see a proof that has trace_state, try to add one more line right before the trace_state. Comment your code profusely with what the status is, since that context will be valuable for the next LLM.
  
  CRITICAL RULES:
  - The ORIGINAL file contains EXACTLY {sorry_count} "sorry" keywords - your JSON array must have EXACTLY {sorry_count} elements
  - Provide exactly one replacement for each "sorry" in the file, in the exact order they appear (top to bottom)
  - Each replacement should be the exact code/proof that goes where "sorry" appears
  - IMPORTANT: Your replacement text goes directly where the "sorry" is - if you need helper functions, define them inline within the replacement
  - You may use "sorry" temporarily in early iterations to get error feedback, but must remove all verification bypasses for final success
  - Use valid Lean syntax for all replacements
  - You may include helper definitions, theorems, and lemmas in replacements when needed
  - For helper definitions added within a replacement, add comment -- LLM HELPER before them
  - Return ONLY a valid JSON array, no explanations or markdown
  
  LEAN FILE WITH SORRY PLACEHOLDERS:
  {code}

fix_verification: |
  The task is to fix implementations and proofs that failed verification by providing replacements for any remaining "sorry" placeholders.
  
  INPUT: The ORIGINAL file contains {sorry_count} "sorry" keywords that need to be replaced based on verification errors.
  
  OUTPUT: Return a JSON array with EXACTLY {sorry_count} fixed replacements (one for each "sorry" in the ORIGINAL file), in order from top to bottom:
  ```json
  ["fixed_implementation", "fixed_proof", "another_fixed_implementation"]
  ```

  STRATEGY: Do a high-level plan using sorries. Then focus on eliminating the sorries one by one. To eliminate a sorry, try a proof. Likely there will be an error. Replace every line after that error (until the end of the subgoal) with trace_state and then sorry. Then slowly push the subproof forward one correct line at a time, backtracking a line when the line is wrong. Also try grind on small sorries.

  To summarize, if you see no proof at all, make a high-level sketch proof that uses sorries and trace_state. If you see a high-level sketch proof that uses sorries, insert trace_state before the first sorry. If you see a proof that has trace_state, try to add one more line right before the trace_state. Comment your code profusely with what the status is, since that context will be valuable for the next LLM.


  CRITICAL RULES:
  - Your proof should differ only in one line from the proof you're trying to fix. The one line you can change is the one before trace_state. You will make mistakes if you try to change multiple lines.
  - Always have trace_state before a sorry so you know what the proof state is.
  - The ORIGINAL file contains EXACTLY {sorry_count} "sorry" keywords - your JSON array must have EXACTLY {sorry_count} elements
  - Provide exactly one replacement for each "sorry" in the file, in the exact order they appear (top to bottom)
  - Each replacement should be the exact fixed code/proof that goes where "sorry" appears
  - IMPORTANT: Your replacement text goes directly where the "sorry" is - if you need helper functions, define them inline within the replacement
  - You may use "sorry" temporarily to get error feedback, but each iteration should remove more verification bypasses
  - Use valid Lean syntax for all replacements
  - You may include helper definitions, theorems, and lemmas in replacements when needed
  - For helper definitions added within a replacement, add comment -- LLM HELPER before them
  - Return ONLY a valid JSON array, no explanations or markdown
  
  ITERATION STRATEGY: You can use "sorry" strategically in intermediate iterations to understand the proof structure and get helpful error messages from Lean. However, you must progressively remove all verification bypasses - the final iteration must have zero verification bypasses for success.
  
  ERROR DETAILS from Lean verification:
  {errorDetails}

  ORIGINAL FILE (for context):
  {original_code}

  CURRENT ITERATION FILE (with failed implementations to learn from):
  {code}
