vc-preamble: |-
  use vstd::prelude::*;
  
  verus! {
  
  // 1 a)
  
  // [ai, aj[
  spec fn sum(a: Seq<int>, i: int, j: int) -> int
      recommends 0 <= i <= j <= a.len()
      decreases j - i
      when 0 <= i <= j <= a.len()
  {
      if i == j { 0 }
      else { a[j-1] + sum(a, i, j-1) }
  }
  
  // 1 b)
  
  // 1 c)
  // a -> [1, 10, 3, âˆ’4, 5]
  // c -> [0, 1, 11, 14, 10, 15]
  
  spec fn is_prefix_sum_for(a: Seq<int>, c: Seq<int>) -> bool
  {
      a.len() + 1 == c.len() && 
      forall|i: int| #![auto] 0 <= i <= a.len() ==> c[i] == sum(a, 0, i)
  }

vc-helpers: |-
  proof fn prefix_sum_difference(a: Seq<int>, c: Seq<int>, i: int, j: int)
      requires 0 <= i <= j <= a.len(),
               is_prefix_sum_for(a, c)
      ensures c[j] - c[i] == sum(a, i, j)
      decreases j - i
  {
      if i == j {
          assert(c[j] - c[i] == 0);
          assert(sum(a, i, j) == 0);
      } else {
          prefix_sum_difference(a, c, i, j - 1);
          assert(c[j] == sum(a, 0, j));
          assert(c[i] == sum(a, 0, i));
          assert(c[j - 1] == sum(a, 0, j - 1));
          assert(sum(a, i, j) == sum(a, i, j - 1) + a[j - 1]);
          assert(c[j] == c[j - 1] + a[j - 1]);
          assert(c[j] - c[i] == (c[j - 1] + a[j - 1]) - c[i]);
          assert(c[j] - c[i] == (c[j - 1] - c[i]) + a[j - 1]);
          assert(c[j - 1] - c[i] == sum(a, i, j - 1));
          assert(c[j] - c[i] == sum(a, i, j - 1) + a[j - 1]);
          assert(c[j] - c[i] == sum(a, i, j));
      }
  }

vc-spec: |-
  // <vc-spec>
  proof fn queryFast(a: Seq<int>, c: Seq<int>, i: int, j: int) -> (r: int)
      requires 0 <= i <= j <= a.len(),
               is_prefix_sum_for(a, c)
      ensures r == sum(a, i, j)
  // </vc-spec>

vc-code: |-
  proof fn queryFast(a: Seq<int>, c: Seq<int>, i: int, j: int) -> (r: int)
      requires 0 <= i <= j <= a.len(),
               is_prefix_sum_for(a, c)
      ensures r == sum(a, i, j)
  {
      prefix_sum_difference(a, c, i, j);
      c[j] - c[i]
  }

vc-postamble: |-
  fn main() {
  }
  
  }

